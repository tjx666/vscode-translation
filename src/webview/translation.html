<!DOCTYPE html>
<html>

<head>
    <title>Translation</title>
    <link rel="stylesheet" href="vscode-codicons" />
    <link rel="stylesheet" href="css/common.css" />
    <style>
        .headLeft,
        .headCenter,
        .headRight {
            display: inline-block;
        }

        .textArea {
            width: 100%;
        }

        .headCenter {
            width: 30px;
            text-align: center;
            vertical-align: top;
        }

        .headLeft,
        .headRight {
            width: calc(50% - 15px);
            vertical-align: top;
        }

        .headOperation {
            margin: 5px 0px;
        }

        .history {
            margin: 7px 0px 20px 0px;
        }

        .translate {
            margin-bottom: 20px;
        }

        .langSelect {
            width: 150px;
            margin-right: 10px;
        }

        .historyPanel {
            z-index: 3;
            position: absolute;
            margin-left: 20px;
            border: 1px solid;
            background-color: var(--vscode-editor-background);
            width: 200px;
            height: 300px;
            text-align: left;
            overflow-x: hidden;
            overflow-y: auto;
        }

        .historyItem {
            padding: 3px 5px;
            cursor: pointer;
        }

        .historyItem:hover {
            background-color: var(--vscode-button-background);
        }

        .operationButton {
            margin-right: 5px;
        }

        .operationGroup {
            display: inline-block;
        }

        .pronunceButton,
        .pronunce {
            vertical-align: middle;
        }

        .pronunceButton {
            margin-right: 5px;
        }

        .pronunce.withSrc {
            margin-right: 5px;
        }

        .pronunceSourceLang {
            color: var(--vscode-gitDecoration-addedResourceForeground);
        }
    </style>
</head>

<body>

    <div id="app">
        <div>
            <form>
                <div class="headLeft">
                    <div class="headOperation">
                        <vscode-dropdown class="langSelect" v-model="state.sourceLang"
                            @change="sourceLangChange($event.target.value)">
                            <vscode-option v-for="(i, index) in sourceLangList" :key="i.key + index" :value="i.key"
                                :title="i.label">{{i.label}}</vscode-option>
                        </vscode-dropdown>
                        <div class="operationGroup">
                            <vscode-button class="operationButton first" appearance="icon" title="Copy"
                                @click="copyAction('source')">
                                <span class="codicon codicon-repo-pull"></span>
                            </vscode-button>
                            <vscode-button class="operationButton" appearance="icon" title="Paste"
                                @click="pasteAction('source')">
                                <span class="codicon codicon-repo-push"></span>
                            </vscode-button>
                            <vscode-button class="operationButton" appearance="icon" title="Clear"
                                @click="clearAction('source')">
                                <span class="codicon codicon-trash"></span>
                            </vscode-button>
                        </div>
                    </div>
                    <div>
                        <vscode-text-area v-model="state.source" class="textArea" rows="5" maxlength="5000">
                        </vscode-text-area>
                    </div>
                    <div>
                        <div>
                            <vscode-button class="pronunceButton" appearance="icon" @click="pronunciation('source')">
                                <span class="codicon codicon-unmute"></span>
                            </vscode-button>
                            <span class="pronunce withSrc">{{sourcePronunce}}</span>
                            <span class="pronunceSourceLang">{{pronunceSourceLang}}</span>
                        </div>
                    </div>
                </div>

                <div class="headCenter">
                    <div class="history">
                        <vscode-button appearance="icon" title="History" @click="showHistory = true"
                            @focusout="hideHistory()">
                            <span class="codicon codicon-history"></span>
                        </vscode-button>
                        <div v-if="showHistory" class="historyPanel">
                            <div v-for="(i, index) in state.history" :key="i + index" class="historyItem" :title="i"
                                @click="historySelect(i)">{{i}}</div>
                        </div>
                    </div>
                    <div class="translate">
                        <vscode-button appearance="icon" title="Translate" @click="query()">
                            <span class="codicon codicon-play"></span>
                        </vscode-button>
                    </div>
                    <div>
                        <vscode-button appearance="icon" title="Swap" @click="swapAction()">
                            <span class="codicon codicon-arrow-swap"></span>
                        </vscode-button>
                    </div>
                </div>

                <div class="headRight">
                    <div class="headOperation">
                        <vscode-dropdown class="langSelect" v-model="state.targetLang"
                            @change="targetLangChange($event.target.value)">
                            <vscode-option v-for="(i, index) in targetLangList" :key="i.key + index" :value="i.key"
                                :title="i.label">{{i.label}}</vscode-option>
                        </vscode-dropdown>
                        <div class="operationGroup">
                            <vscode-button class="operationButton first" appearance="icon" title="Copy"
                                @click="copyAction('target')">
                                <span class="codicon codicon-repo-pull"></span>
                            </vscode-button>
                            <vscode-button class="operationButton" appearance="icon" title="Paste"
                                @click="pasteAction('target')">
                                <span class="codicon codicon-repo-push"></span>
                            </vscode-button>
                            <vscode-button class="operationButton" appearance="icon" title="Clear"
                                @click="clearAction('target')">
                                <span class="codicon codicon-trash"></span>
                            </vscode-button>
                        </div>
                    </div>
                    <div>
                        <vscode-text-area v-model="state.target" class="textArea" rows="5" maxlength="5000">
                        </vscode-text-area>
                    </div>
                    <div>
                        <div>
                            <vscode-button class="pronunceButton" appearance="icon" @click="pronunciation('target')">
                                <span class="codicon codicon-unmute"></span>
                            </vscode-button>
                            <span class="pronunce">{{targetPronounce}}</span>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <vscode-divider></vscode-divider>

        <div>
            <vscode-progress-ring v-if="state.loading"></vscode-progress-ring>
            <div v-if="state.result" id="definitions" class="block">
                <div class="title">Definitions</div>
                <div class="list">
                    <template v-for="(i, i_index) in state.result.definitions" :key="i.pos + i_index">
                        <div class="definition">
                            <div class="pos">{{i.pos}}</div>
                            <template v-for="(j, j_index) in i.entry" :key="j.definition_id + j_index">
                                <div class="item">
                                    <div class="gloss">{{j.gloss}}</div>
                                    <div class="example">{{j.example}}</div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="vscode-webview-ui-toolkit"></script>
    <script src="js/vue3.js"></script>
    <script src="js/common.js"></script>
    <script src="js/language.js"></script>
    <script>
        'use strict';
        const vscode = acquireVsCodeApi();

        const app = Vue.createApp({
            data() {
                return {
                    state: {
                        sourceLang: 'auto',
                        targetLang: 'en',
                        source: null,
                        target: null,
                        result: null,
                        history: [],
                        loading: false,
                        temp: null,
                    },
                    sourceLangList: SOURCE_LANGUAGE,
                    targetLangList: TARGET_LANGUAGE,
                    showHistory: false,
                };
            },
            created() {
                setTimeout(() => {
                    let preState = vscode.getState();
                    if (preState) this.state = preState;
                }, 100);
            },
            computed: {
                sourcePronunce() {
                    return this.state.result ?
                        this.state.result.sentences[1] ?
                            this.state.result.sentences[1].src_translit : '' : '';
                },
                targetPronounce() {
                    return this.state.result ?
                        this.state.result.sentences[1] ?
                            this.state.result.sentences[1].translit : '' : '';
                },
                pronunceSourceLang() {
                    if (!this.state.result) {
                        return '';
                    }
                    for (let i in this.sourceLangList) {
                        if (this.sourceLangList[i].key === this.state.result.src) {
                            return `(${this.sourceLangList[i].label})`;
                        }
                    }
                    return '';
                },
            },
            watch: {
                'state.source'() {
                    this.setState();
                },
                'state.target'() {
                    this.setState();
                },
            },
            methods: {
                setState() {
                    vscode.setState(this.state);
                },
                sourceLangChange(value) {
                    this.state.sourceLang = value;
                    this.setState();
                },
                targetLangChange(value) {
                    this.state.targetLang = value;
                    this.setState();
                },
                hideHistory() {
                    setTimeout(() => this.showHistory = false, 200);
                },
                copyAction(target) {
                    if (this.state[target]) {
                        window.navigator.clipboard.writeText(this.state[target]);
                    }
                },
                pasteAction(target) {
                    window.navigator.clipboard.readText().then(text => {
                        if (text) {
                            this.state[target] = text;
                        }
                    });
                },
                historySelect(text) {
                    this.state.source = text;
                    this.query();
                },
                swapAction() {
                    let t = this.state.source;
                    this.state.source = this.state.target;
                    this.state.target = t;
                    this.query();
                },
                pronunciation(type) {
                    if (this.state.temp) {
                        switch (type) {
                            case 'source': {
                                vscode.postMessage({
                                    operation: 'getTts',
                                    parameter: {
                                        sl: this.state.temp.sourceLang,
                                        tl: this.state.temp.sourceLang,
                                        q: this.state.temp.source,
                                    },
                                });
                                break;
                            }
                            case 'target': {
                                vscode.postMessage({
                                    operation: 'getTts',
                                    parameter: {
                                        sl: this.state.temp.targetLang,
                                        tl: this.state.temp.targetLang,
                                        q: this.state.temp.target,
                                    },
                                });
                                break;
                            }
                        }
                    }
                },
                clearAction(target) {
                    this.state[target] = null;
                },
                init(initState) {
                    this.state.sourceLang = initState.sl;
                    this.state.targetLang = initState.tl;
                    this.state.source = initState.q;
                    this.setState();
                    this.query();
                },
                query() {
                    if (this.state.source) {
                        this.state.target = null;
                        this.state.result = null;
                        this.state.loading = true;
                        this.state.history.push(this.state.source);
                        vscode.postMessage({
                            operation: 'getTranslate',
                            parameter: {
                                hl: this.state.targetLang,
                                tl: this.state.targetLang,
                                sl: this.state.sourceLang,
                                q: this.state.source,
                            },
                        });
                        this.setState();
                    }
                },
                receiveMessage(message) {
                    switch (message.operation) {
                        case 'init': {
                            this.init(message.parameter);
                            break;
                        }
                        case 'query': {
                            this.state.source = message.parameter.q;
                            this.query();
                            break;
                        }
                        case 'receiveTranslation': {
                            this.state.result = message.parameter;
                            this.state.target = message.parameter.sentences[0].trans;
                            this.state.temp = {
                                source: this.state.result.sentences[0].orig,
                                target: this.state.result.sentences[0].trans,
                                sourceLang: this.state.result.src,
                                targetLang: this.state.targetLang,
                            };
                            this.state.loading = false;
                            this.setState();
                            break;
                        }
                    }
                },
            },
        });
        app.config.compilerOptions.isCustomElement = tag => tag.startsWith('vscode-');
        const appInstance = app.mount('#app');

        window.addEventListener('message', event => {
            appInstance.receiveMessage(event.data);
        });
    </script>
</body>

</html>
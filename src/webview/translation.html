<!DOCTYPE html>
<html>

<head>
    <title>Translation</title>
    <style>
        body {
            font-family: var(--vscode-editor-font-family);
            font-weight: var(--vscode-editor-font-weight);
            font-size: var(--vscode-editor-font-size);
        }
    </style>
</head>

<body>
    <div id="app">
        <div>

        </div>
        <div>
            <div v-if="state.result" id="definitions" class="block">
                <div class="title">Definitions</div>
                <div class="list">
                    <template v-for="(i, i_index) in state.result.definitions" :key="i.pos + i_index">
                        <div class="definition">
                            <div class="pos">{{i.pos}}</div>
                            <template v-for="(j, j_index) in i.entry" :key="j.definition_id + j_index">
                                <div class="item">
                                    <div class="gloss">{{j.gloss}}</div>
                                    <div class="example">{{j.example}}</div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>
    <script src="js/vue3.js"></script>
    <script src="js/common.js"></script>
    <script src="js/language.js"></script>
    <script>
        'use strict';
        const vscode = acquireVsCodeApi();

        let app = Vue.createApp({
            data() {
                return {
                    state: {
                        sourceLang: 'auto',
                        targetLang: 'en',
                        source: '',
                        target: '',
                        result: null,
                        history: [],
                    },
                };
            },
            created() {
                let preState = vscode.getState();
                if (preState) this.state = preState;
            },
            methods: {
                init(initState) {
                    this.state.sourceLang = initState.sl;
                    this.state.targetLang = initState.tl;
                    this.state.source = initState.q;
                    this.query();
                },
                query() {
                    if (this.state.source) {
                        if (this.state.source) {
                            this.state.history.push(this.state.source);
                        }
                        vscode.postMessage({
                            operation: 'getTranslate',
                            parameter: {
                                hl: this.state.targetLang,
                                tl: this.state.targetLang,
                                sl: this.state.sourceLang,
                                q: this.state.source,
                            },
                        });
                        vscode.setState(this.state);
                    }
                },
                receiveMessage(message) {
                    switch (message.operation) {
                        case 'init': {
                            this.init(message.parameter);
                            break;
                        }
                        case 'query': {
                            this.state.source = message.parameter.q;
                            this.query();
                            break;
                        }
                        case 'receiveTranslation': {
                            this.state.result = message.parameter;

                            break;
                        }
                        case 'receivePronunciation': {
                            // TODO
                            break;
                        }
                    }
                }
            },
        });
        app.config.compilerOptions.isCustomElement = tag => tag.startsWith('vscode-');
        let appInstance = app.mount('#app');

        window.addEventListener('message', event => {
            appInstance.receiveMessage(event.data);
        });
    </script>
</body>

</html>